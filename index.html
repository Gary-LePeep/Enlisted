<!DOCTYPE html>
<html>

<head>

<body style="background-color:rgb(107, 133, 133);"></body>
<title>
    Enlisted weapon comparison tool
</title>

<script type="text/javascript" src="weapon-data.js"></script>
<script src="jquery-3.6.0.min.js"></script>
<script src="./dist/chart.min.js"></script>


<script>
    // Create new css link Element
    var css = document.createElement('link');
    css.rel = 'stylesheet';
    css.type = 'text/css';
    css.href = 'style.css';
    document.getElementsByTagName('HEAD')[0].appendChild(css);
</script>
</head>

<body>
    <div class="TITLE">Enlisted weapon comparison tool</div>

    <script>
        var btncolors = ["greenbtn", "redbtn", "bluebtn", "magbtn"]
        for (var i = 0; i < 4; i++) (function (i) {
            var dropdown = document.createElement('div');
            dropdown.className = "dropdown";
            document.getElementsByTagName('BODY')[0].appendChild(dropdown);

            var button = document.createElement('button');
            button.className = "dropbtn " + btncolors[i];
            button.textContent = "Weapon " + (i + 1);
            dropdown.append(button);

            var content = document.createElement('div');
            content.className = "dropdown-content";
            dropdown.append(content);

            for (var j = 0; j < WEAPONS.length; j++) (function (j) {
                var wepbutton = document.createElement('button');
                wepbutton.className = "wepbtn";
                wepbutton.textContent = WEAPONS[j].Name == null ? "(Remove)" : WEAPONS[j].Name;
                wepbutton.onclick = function () {
                    button.textContent = wepbutton.textContent == "(Remove)" ? "Weapon " + (i + 1) : wepbutton.textContent;

                    // update labels
                    var chartColors = ['rgba(0, 175, 0)', 'rgba(175, 0, 0)', 'rgba(0, 0, 175)', 'rgba(175, 0, 175)']
                    if (wepbutton.textContent == "(Remove)") {
                        // reset
                        window.ttk_dpm_chart.data.datasets[i] = {
                            label: 'Weapon ' + (i + 1),
                            backgroundColor: [chartColors[i]],
                            borderColor: [chartColors[i]],
                            borderWidth: 5
                        }
                    }
                    else {
                        // set legend to label
                        window.ttk_dpm_chart.data.datasets[i].label = wepbutton.textContent
                    }

                    // find max range of all selected guns
                    var range = 0;
                    for (var k = 0; k < 4; k++) (function (k) {
                        var wepData = weaponByName(window.ttk_dpm_chart.data.datasets[k].label)
                        if (wepData != null && wepData.Range > range) {
                            range = wepData.Range
                        }
                    })(k);
                    // set x axis to range, in 1/15th increments
                    var ranges = [];
                    for (var k = 0; k <= 15; k++) (function (k) {
                        ranges.push(range * k / 15);
                    })(k);
                    // if range changed, reload all data just to be sure
                    if (window.ttk_dpm_chart.data.labels[15] != ranges[15]) {
                        window.ttk_dpm_chart.data.labels = ranges;
                        ttk_dpm_reload()
                    }

                    // update data
                    var chartColors = ['rgba(0, 175, 0)', 'rgba(175, 0, 0)', 'rgba(0, 0, 175)', 'rgba(175, 175, 0)']
                    if (wepbutton.textContent == "(Remove)") {
                    }
                    else {
                        if (document.getElementById('ttk_dpm_dropdown').value == "Damage over Distance") {
                            var data = []
                            var wepData = weaponByName(wepbutton.textContent).Damage;
                            for (var k = 0; k <= 15; k++) (function (k) {
                                data.push(wepData.a + (wepData.b * (2.71828 ** (-wepData.c * ranges[k]))));
                            })(k);
                            window.ttk_dpm_chart.data.datasets[i].data = data;
                        }
                        if (document.getElementById('ttk_dpm_dropdown').value == "Shots to Kill over Distance") {
                            var data = []
                            var wepData = weaponByName(wepbutton.textContent).Damage;
                            for (var k = 0; k <= 15; k++) (function (k) {
                                var damage_at_dist = (wepData.a + (wepData.b * (2.71828 ** (-wepData.c * ranges[k]))));
                                var shots_to_kill = Math.ceil(10 / damage_at_dist);
                                data.push(shots_to_kill)
                            })(k);
                            window.ttk_dpm_chart.data.datasets[i].data = data;
                        }
                        if (document.getElementById('ttk_dpm_dropdown').value == "Time to Kill over Distance") {
                            var data = []
                            var wepData = weaponByName(wepbutton.textContent);
                            for (var k = 0; k <= 15; k++) (function (k) {
                                var damage_at_dist = (wepData.Damage.a + (wepData.Damage.b * (2.71828 ** (-wepData.Damage.c * ranges[k]))));
                                var shots_to_kill = Math.ceil(10 / damage_at_dist);
                                var time_to_kill = (shots_to_kill - 1) * (60 / wepData.RPM)
                                console.log(time_to_kill)
                                data.push(time_to_kill)
                            })(k);
                            window.ttk_dpm_chart.data.datasets[i].data = data;
                        }
                        if (document.getElementById('ttk_dpm_dropdown').value == "Damage per Minute over Distance") {
                            var data = []
                            var wepData = weaponByName(wepbutton.textContent);
                            for (var k = 0; k <= 15; k++) (function (k) {
                                data.push(wepData.RPM * (wepData.Damage.a + (wepData.Damage.b * (2.71828 ** (-wepData.Damage.c * ranges[k])))));
                            })(k);
                            window.ttk_dpm_chart.data.datasets[i].data = data;
                        }
                    }

                    // refresh
                    window.ttk_dpm_chart.update();
                };
                content.append(wepbutton);
            })(j);
        })(i)

        function ttk_dpm_reload() {
            var buttons = document.getElementsByClassName("dropbtn");
            for (var i = 0; i < buttons.length; i++) {
                var text = buttons[i].textContent;
                var wepbtns = buttons[i].parentElement.getElementsByClassName("wepbtn");
                for (var j = 0; j < wepbtns.length; j++) {
                    if (wepbtns[j].textContent == buttons[i].textContent) {
                        wepbtns[j].onclick();
                    }
                }
            }
        }

        function weaponByName(name) {
            return WEAPONS.filter(function (WEAPONS) { return (WEAPONS['Name'] == name); })[0];
        }
    </script>

    <br><br><br>
    <b> Display the following: </b>
    <select id="ttk_dpm_dropdown" onchange="ttk_dpm_reload()">
        <option> Damage over Distance </option>
        <option> Damage per Minute over Distance </option>
        <option> Shots to Kill over Distance </option>
        <option> Time to Kill over Distance </option>
    </select>
    <br><br><br>
    <canvas id="myChart"></canvas>
    <img src="resources/gray.jpg" style="position:absolute; top:200px; left:10px; width:800px; height:400px;">
    <div style="position:absolute; top:200px; left:10px; width:800px; height:800px;">
        <canvas id="ttk-dpm-chart"></canvas>

        <script type="text/javascript">
            Chart.defaults.color = "#cccccc";
            Chart.defaults.borderColor = "#888888";
            var indicatedValueData = {
                type: 'line',
                labels: [],
                datasets: [{
                    label: 'Weapon 1',
                    backgroundColor: ['rgba(0, 175, 0)'],
                    borderColor: ['rgba(0, 175, 0)'],
                    borderWidth: 5,
                },
                {
                    label: 'Weapon 2',
                    backgroundColor: ['rgba(175, 0, 0)'],
                    borderColor: ['rgba(175, 0, 0)'],
                    borderWidth: 5
                },
                {
                    label: 'Weapon 3',
                    backgroundColor: ['rgba(0, 0, 175)'],
                    borderColor: ['rgba(0, 0, 175)'],
                    borderWidth: 5,
                },
                {
                    label: 'Weapon 4',
                    backgroundColor: ['rgba(175, 0, 175)'],
                    borderColor: ['rgba(175, 0, 175)'],
                    borderWidth: 5,
                }]
            }
            var opts = {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }

            var chart = document.getElementById("ttk-dpm-chart").getContext("2d");
            window.ttk_dpm_chart = new Chart(chart, { type: "line", data: indicatedValueData, options: opts });
        </script>
    </div>



</body>

</html>