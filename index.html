<!DOCTYPE html>
<html>

<head>

<body style="background-color:rgb(107, 133, 133);"></body>
<title>
    Enlisted weapon comparison tool
</title>

<script type="text/javascript" src="weapon-data.js"></script>
<script src="jquery-3.6.0.min.js"></script>
<script src="./dist/chart.min.js"></script>
<script src="./dist/chartjs-plugin-annotation.min.js"></script>


<script>
    // Create new css link Element
    var css = document.createElement('link');
    css.rel = 'stylesheet';
    css.type = 'text/css';
    css.href = 'style.css';
    document.getElementsByTagName('HEAD')[0].appendChild(css);
</script>
</head>

<body>
    <div class="TITLE">Enlisted weapon comparison tool</div>

    <!-- Vitality switch -->
    <input type="checkbox" id="vitalityCheck" onclick="vitality()" style="position:absolute; top:200px; left:820px;">
    <b style="position:absolute; top:201px; left:845px;"> Has vitality perk </b>

    <!-- Body armor switch -->
    <input type="checkbox" id="armorCheck" onclick="bodyArmor()" style="position:absolute; top:225px; left:820px;">
    <b style="position:absolute; top:226px; left:845px;"> Wearing body armor </b>

    <script>
        var MAX_DMG = document.getElementById("vitalityCheck").checked ? 13.5 : 10
        var ARMOR_MULT = document.getElementById("armorCheck").checked ? 0.9 : 1
        var btncolors = ["greenbtn", "redbtn", "bluebtn", "magbtn"]

        var headerbox = document.createElement('header');
        headerbox.id = "header-box";
        document.getElementsByTagName('BODY')[0].appendChild(headerbox);

        var header = document.createElement('div');
        header.className = "header";
        headerbox.append(header);

        var primary = document.createElement("nav");
        //primary.className("primary");
        header.append(primary);

        var primarylist = document.createElement("ul");
        primary.append(primarylist)
        for (var h = 0; h < 4; h++) (function (h) {
            var colorButton = document.createElement("li");
            colorButton.className = "link topbtn " + btncolors[h];
            primarylist.append(colorButton);

            var colorButtonText = document.createElement("a");
            colorButtonText.style = "color: white";
            colorButtonText.text = "Weapon " + (h + 1);
            colorButton.append(colorButtonText);

            var categorylist = document.createElement("ul");
            colorButton.append(categorylist)

            for (var i = -1; i < WEAPONS.length; i++) (function (i) {
                var categoryButton = document.createElement("li");
                categoryButton.className = "Link submenu";
                categorylist.append(categoryButton);

                var categoryButtonText = document.createElement("a");
                categoryButtonText.text = i < 0 ? "(Remove)" : WEAPONS[i].Category;
                categoryButton.append(categoryButtonText);

                categoryButton.onclick = function () {
                    if (categoryButtonText.text == "(Remove)") {
                        // reset color button
                        colorButtonText.text = "Weapon " + (h + 1);

                        // remove data point
                        var chartColors = ['rgba(0, 158, 115)', 'rgba(207, 52, 55)', 'rgba(71, 75, 182)', 'rgba(213, 92, 5)']
                        window.ttk_dpm_chart.data.datasets[h] = {
                            label: 'Weapon ' + (h + 1),
                            backgroundColor: [chartColors[h]],
                            borderColor: [chartColors[h]],
                            borderWidth: 5
                        }
                        window.ttk_dpm_chart.update();
                    }
                }

                var weaponlist = document.createElement("ul");
                categoryButton.append(weaponlist)

                for (var j = 0; i >= 0 && j < WEAPONS[i].Weapons.length; j++) (function (j) {
                    var weaponButton = document.createElement("li");
                    weaponButton.className = "link submenu";
                    weaponlist.append(weaponButton);

                    var weaponButtonText = document.createElement("a");
                    weaponButtonText.text = WEAPONS[i].Weapons[j].Name;
                    weaponButton.append(weaponButtonText);
                    weaponButton.tagName = weaponButtonText.text;

                    weaponButton.onclick = function () {
                        // set color button name to selected weapon
                        colorButtonText.text = weaponButtonText.text

                        // set legend to label
                        window.ttk_dpm_chart.data.datasets[h].label = weaponButtonText.text

                        // find max range of all selected guns
                        var range = 0;
                        for (var k = 0; k < 4; k++) (function (k) {
                            var wepData = weaponByName(window.ttk_dpm_chart.data.datasets[k].label)
                            if (wepData != null && wepData.Range > range) {
                                range = wepData.Range
                            }
                        })(k);
                        // set x axis to range, in 1/15th increments
                        var ranges = [];
                        for (var k = 0; k <= 15; k++) (function (k) {
                            ranges.push(range * k / 15);
                        })(k);
                        // if range changed, reload all data just to be sure
                        if (window.ttk_dpm_chart.data.labels[15] != ranges[15]) {
                            window.ttk_dpm_chart.data.labels = ranges;
                            ttk_dpm_reload()
                        }

                        // update data
                        show_death_threshold = false;
                        var data = [];
                        var wepData = weaponByName(weaponButtonText.text);
                        for (var k = 0; k <= 15; k++) (function (k) {
                            var damage_at_dist = (wepData.Damage.a + (wepData.Damage.b * (2.71828 ** (-wepData.Damage.c * Math.max(ranges[k], 10)))) * ARMOR_MULT);
                            damage_at_dist = Math.max(damage_at_dist, 0.1);
                            var shots_to_kill = Math.ceil(MAX_DMG / damage_at_dist);
                            if (document.getElementById('ttk_dpm_dropdown').value == "Damage over Distance") {
                                show_death_threshold = true;
                                data.push(damage_at_dist);
                            }
                            if (document.getElementById('ttk_dpm_dropdown').value == "Shots to Kill over Distance") {
                                data.push(shots_to_kill)
                            }
                            if (document.getElementById('ttk_dpm_dropdown').value == "Time to Kill over Distance") {
                                var time_to_kill = (shots_to_kill - 1) * (60 / wepData.RPM)
                                data.push(time_to_kill)
                            }
                            if (document.getElementById('ttk_dpm_dropdown').value == "Damage per Minute over Distance") {
                                data.push(wepData.RPM * damage_at_dist);
                            }
                        })(k);

                        // set data
                        window.ttk_dpm_chart.data.datasets[h].data = data;
                        window.ttk_dpm_chart.options.plugins.annotation.annotations.line1.borderWidth = show_death_threshold ? 2 : 0;
                        window.ttk_dpm_chart.options.plugins.annotation.annotations.line1.yMax = show_death_threshold ? MAX_DMG : 0;
                        window.ttk_dpm_chart.options.plugins.annotation.annotations.line1.yMin = show_death_threshold ? MAX_DMG : 0;

                        // refresh
                        window.ttk_dpm_chart.update();
                    }
                })(j)
            })(i)
        })(h)

        function ttk_dpm_reload() {
            var buttons = document.getElementsByClassName("topbtn");
            for (var i = 0; i < buttons.length; i++) {
                var text = buttons[i].childNodes[0].textContent
                var wepbtns = buttons[i].getElementsByTagName("LI");
                for (var j = 0; j < wepbtns.length; j++) {
                    if (wepbtns[j].textContent == text) {
                        console.log(wepbtns[j])
                        wepbtns[j].onclick();
                    }
                }
            }
        }

        function weaponByName(name) {
            for (var i = 0; i < WEAPONS.length; i++) {
                for (var j = 0; j < WEAPONS[i].Weapons.length; j++) {
                    if (WEAPONS[i].Weapons[j].Name == name) {
                        return WEAPONS[i].Weapons[j];
                    }
                }
            }
        }

        function vitality() {
            MAX_DMG = document.getElementById("vitalityCheck").checked ? 13.5 : 10
            ttk_dpm_reload()
        }

        function bodyArmor() {
            ARMOR_MULT = document.getElementById("armorCheck").checked ? 0.9 : 1
            ttk_dpm_reload()
        }
    </script>


    <br><br><br>
    <b> Display the following: </b>
    <select id="ttk_dpm_dropdown" onchange="ttk_dpm_reload()">
        <option> Damage over Distance </option>
        <option> Damage per Minute over Distance </option>
        <option> Shots to Kill over Distance </option>
        <option> Time to Kill over Distance </option>
    </select>
    <br><br><br>
    <canvas id="myChart"></canvas>
    <img src="resources/gray.jpg" style="position:absolute; top:200px; left:10px; width:800px; height:400px;">
    <div style="position:absolute; top:200px; left:10px; width:800px; height:800px;">
        <canvas id="ttk-dpm-chart"></canvas>

        <script type="text/javascript">
            Chart.defaults.color = "#cccccc";
            Chart.defaults.borderColor = "#888888";
            var indicatedValueData = {
                type: 'line',
                labels: [],
                datasets: [{
                    label: 'Weapon 1',
                    backgroundColor: ['rgba(0, 158, 115)'],
                    borderColor: ['rgba(0, 158, 115)'],
                    borderWidth: 5,
                },
                {
                    label: 'Weapon 2',
                    backgroundColor: ['rgba(207, 52, 55)'],
                    borderColor: ['rgba(207, 52, 55)'],
                    borderWidth: 5
                },
                {
                    label: 'Weapon 3',
                    backgroundColor: ['rgba(71, 75, 182)'],
                    borderColor: ['rgba(71, 75, 182)'],
                    borderWidth: 5,
                },
                {
                    label: 'Weapon 4',
                    backgroundColor: ['rgba(213, 92, 5)'],
                    borderColor: ['rgba(213, 92, 5)'],
                    borderWidth: 5,
                }]
            }
            var opts = {
                plugins: {
                    autocolors: false,
                    annotation: {
                        annotations: {
                            line1: {
                                type: 'line',
                                yMin: 10,
                                yMax: 10,
                                borderColor: 'rgb(255, 0, 0)',
                                borderWidth: 0,
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }

            var chart = document.getElementById("ttk-dpm-chart").getContext("2d");
            window.ttk_dpm_chart = new Chart(chart, { type: "line", data: indicatedValueData, options: opts });
        </script>
    </div>

    <br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
    <b> IMPORTANT NOTES: </b>
    <p> Damage at less than 10m is the same as damage at 10m. <br>
        This data accounts for base damage, which is done on body/arm shots. <br>
        Hits to the head and neck do 210% damage, legs do 80% damage. <br>
        Knife hits to the head are counted as hits to the body. <br>
        Berlin allied body armor reduces ALL damage to the body by 10%. <br>
        Helmets do not reduce damage, even with pistol shots. (4.8 damage pistol or more is OHK headshot.) <br>
        Recoil reduction "while standing" reduces recoil in all positions. </p>

    <br><br>
    <p style="text-align: center; color: #002244"> For any issues, suggestions, etc. contact 10art1#8181 on discord </p>

</body>

</html>